
### 기존 구조

- **Libraries:** socks-proxy-agent, axios

```javascript
const axiosInstance = axios.create({
    httpAgent: socksProxyAgent,
    ...
});
```

### 기존 프록시의 문제점
- `httpAgent` 옵션만 설정하였기 때문에 https 스킴을 사용하는 서버에서는 프록시가 무시됨.
(프록시를 적용하지 않은 것과 같은 결과)

나는 이 부분을 모르고 단순히 프록시가 제대로 적용되고 있는 줄 알았다.


#### 1. httpsAgent 옵션 추가

문제점: 특정 프록시에서 인증서 관련 예외 `CERT_HAS_EXPIRED` 발생

- 예외 발생 이유: node.js에서 해당 프록시 서버의 인증서를 확인하는데,
공인되지 않은 인증서 (예시: `O: None, LLC`)일 때 보안 차원에서 미리 차단함.

조작된 인증서를 발급하는 프록시 서버는 중간자 공격(MITM) 가능성이 매우 크기 때문. 
(무료 프록시의 한계)(즉 프록시 서버에서 정보를 감청하기 위해 조작된 인증서 발급)


- 추가 사항: response.request.socket 에서 인증서를 확인할 수 없는 경우도 있다.
이때는 함수를 이용하여 인증서를 확인할 수 있다.

```javascript
new AnyAgent(
    ...
)
.on('keylog', (line, tlsSocket) => tlsCert = tlsSocket.getPeerCertificate(true or false));
```

TLS 핸드셰이크가 완료되어 특정 이벤트(secureConnect?)가 발생하면 인증서 정보가 도착함.
이후 axios 모듈은 응답이 모두 끝난 후 최종 정리를 하는데 이때는 이에 대한 정보가 없기 때문?

따라서 이벤트 리스너를 등록하여 인증서 정보를 확인할 수 있음.


#### 2. 프록시 객체에 옵션 추가
SocksProxyAgent 객체 내에 아래 옵션을 추가하여 인증서 검사를 무시하고 프록시 서버를 통해 목표 서버에 접근 가능함.
```javascript
rejectUnauthorized: false 
```
(하지만 보안상 절대로 권장되지 않으므로 적어도 VPN을 사용하면서 해당 방식을 이용하길 권장.)


#### 3. 무료 프록시 품질 한계

프록시 리스트 사이트에 있는 대부분의 프록시는 속도가 매우 느리거나 닫혀있는 경우가 대부분임.

(내가 찾았던 것 중 품질이 좋은 프록시를 기준으로 함.)
`x-ratelimit-remaining`이 존재하는 사이트에서 실제로 테스트했을 때,

`VPN(한국)`: remaining 값을 준수하며 작은 배치로 처리
`VPN(한국) + 프록시(미국)`: remaining 값을 고려하지 않고 큰 배치로 처리

**단순 VPN**을 사용한 경우가 더욱 빨랐다. 
VPN + 프록시 조합의 경우 remaining 값이 감소하지는 않았으나 **프록시 서버의 속도 이슈**가 큰 몫을 했다.

따라서 이러한 프록시 리스트를 먼저 추출하여 실제 목표 사이트에 테스트(접속 가능, 속도 측정)하는 등...의 프록시 검증 작업이 필요하다.


> **사용 가능한 프록시 조건**
>
>**필수 사항**: 연결 유무, 속도
**선택 사항**: 공인된 인증서를 발급. **(VPN을 사용하고, 개인정보를 요청과 응답에 포함하지 않는 경우에 한하여)**



#### 4. https-proxy-agent 모듈 추가

해당 모듈도 추가하여 https 프록시도 같이 적용할 수 있다.

문제점: 위와 같이 인증서에 관한 예외 발생

